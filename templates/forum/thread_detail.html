{% extends 'base.html' %}
{% load humanize %}

{% block title %}{{ thread.title }} - {{ site_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'forum:index' %}">Форум</a></li>
                <li class="breadcrumb-item"><a href="{% url 'forum:category_detail' thread.category.slug %}">{{ thread.category.name }}</a></li>
                <li class="breadcrumb-item active">{{ thread.title|truncatewords:5 }}</li>
            </ol>
        </nav>

        <div class="card mb-3">
            <div class="card-header">
                <h3 class="thread-title mb-0">{{ thread.title }}</h3>
                <div class="thread-meta">
                    <i class="fas fa-user"></i> {{ thread.author.username }} |
                    <i class="fas fa-clock"></i> {{ thread.created_at|naturaltime }} |
                    <i class="fas fa-eye"></i> {{ thread.views }} просмотров
                </div>
            </div>
            <div class="card-body">
                <div class="post-content">
                    {{ thread.formatted_markdown|safe }}
                </div>
                {% if thread.tags.all %}
                <div class="mt-3">
                    {% for tag in thread.tags.all %}
                    <span class="badge badge-secondary">{{ tag.name }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <h4><i class="fas fa-comments"></i> Ответы ({{ posts.paginator.count }})</h4>

        {% for post in posts %}
        <div class="card mb-3 post-card" id="post-{{ post.id }}">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2 text-center user-info">
                        {% if post.author.avatar %}
                        <img src="{{ post.author.avatar.url }}" class="user-avatar" alt="{{ post.author.username }}">
                        {% else %}
                        <i class="fas fa-user-circle fa-3x text-muted"></i>
                        {% endif %}
                        <h6 class="mt-2">{{ post.author.username }}</h6>
                        {% if post.author.role == 'admin' %}
                        <span class="badge badge-admin">Admin</span>
                        {% elif post.author.role == 'moderator' %}
                        <span class="badge badge-moderator">Модератор</span>
                        {% endif %}
                        <p class="text-muted mb-0"><small>Сообщений: {{ post.author.post_count }}</small></p>
                    </div>
                    <div class="col-md-10">
                        <div class="post-content">
                            {{ post.formatted_markdown|safe }}
                            
                            {% if post.author.signature %}
                            <div class="post-signature">{{ post.author.signature }}</div>
                            {% endif %}
                        </div>
                        <div class="mt-2 d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                {{ post.created_at|naturaltime }}
                                {% if post.is_edited %} (отредактировано: {{ post.edited_at|naturaltime }}){% endif %}
                            </small>
                            <div class="like-buttons">
                                {% if user.is_authenticated %}
                                <button class="btn btn-sm btn-outline-success" onclick="likePost({{ post.id }}, 1)">
                                    <i class="fas fa-thumbs-up"></i> <span id="likes-{{ post.id }}">{{ post.likes_count|default:0 }}</span>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="likePost({{ post.id }}, -1)">
                                    <i class="fas fa-thumbs-down"></i> <span id="dislikes-{{ post.id }}">{{ post.dislikes_count|default:0 }}</span>
                                </button>
                                {% if post.author == user or user.is_moderator %}
                                <a href="{% url 'forum:post_edit' post.pk %}" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i></a>
                                {% endif %}
                                <a href="{% url 'forum:post_report' post.pk %}" class="btn btn-sm btn-outline-warning"><i class="fas fa-flag"></i></a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="alert alert-info">Пока нет ответов.</div>
        {% endfor %}

        <!-- Pagination -->
        {% if posts.has_other_pages %}
        <nav>
            <ul class="pagination justify-content-center">
                {% if posts.has_previous %}
                <li class="page-item"><a class="page-link" href="?page={{ posts.previous_page_number }}">Назад</a></li>
                {% endif %}
                
                <li class="page-item active"><a class="page-link" href="#">Страница {{ posts.number }} из {{ posts.paginator.num_pages }}</a></li>
                
                {% if posts.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ posts.next_page_number }}">Вперед</a></li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}

        {% if user.is_authenticated and not thread.is_locked %}
        <div class="card mt-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-reply"></i> Ответить</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <button type="submit" class="btn btn-success"><i class="fas fa-paper-plane"></i> Отправить</button>
                </form>
            </div>
        </div>
        {% elif thread.is_locked %}
        <div class="alert alert-warning"><i class="fas fa-lock"></i> Тема заблокирована для ответов</div>
        {% else %}
        <div class="alert alert-info">Чтобы ответить, <a href="{% url 'accounts:login' %}">войдите</a> или <a href="{% url 'accounts:signup' %}">зарегистрируйтесь</a>.</div>
        {% endif %}
    </div>
</div>

<script>
function likePost(postId, type) {
    fetch(`/post/${postId}/like/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `type=${type}`
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById(`likes-${postId}`).textContent = data.likes;
        document.getElementById(`dislikes-${postId}`).textContent = data.dislikes;
    });
}
</script>
{% endblock %}
